<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ê³ ë“±í•™êµ 3ë…„</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
            overflow: hidden;
        }

        #game-container {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            overflow: hidden;
            background: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #game-container {
            animation: fadeIn 0.6s ease-out;
        }

        /* HTML ì…ë ¥ í•„ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .phaser-input {
            font-family: 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
            border: 2px solid #b3d9ff;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
        }

        .phaser-input:focus {
            border-color: #1976d2;
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <script>
        // ==================== ë§¤ë‹ˆì € í´ë˜ìŠ¤ë“¤ ====================
        
        class AuthManager {
            constructor() {
                this.storageKey = 'highschool_auth';
                this.userKey = 'highschool_user';
                this.init();
            }

            init() {
                const savedAuth = localStorage.getItem(this.storageKey);
                if (!savedAuth) {
                    const defaultUser = {
                        username: 'admin',
                        password: this.hashPassword('1234'),
                        name: 'ê´€ë¦¬ì',
                        createdAt: new Date().toISOString()
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(defaultUser));
                }
            }

            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            }

            login(username, password) {
                const savedAuth = localStorage.getItem(this.storageKey);
                if (!savedAuth) return false;

                const user = JSON.parse(savedAuth);
                const hashedPassword = this.hashPassword(password);

                if (user.username === username && user.password === hashedPassword) {
                    const session = {
                        isLoggedIn: true,
                        username: user.username,
                        name: user.name,
                        loginTime: new Date().toISOString()
                    };
                    sessionStorage.setItem(this.userKey, JSON.stringify(session));
                    return true;
                }
                return false;
            }

            logout() {
                sessionStorage.removeItem(this.userKey);
            }

            isLoggedIn() {
                const session = sessionStorage.getItem(this.userKey);
                return session !== null;
            }

            getCurrentUser() {
                const session = sessionStorage.getItem(this.userKey);
                return session ? JSON.parse(session) : null;
            }
        }

        class DataManager {
            constructor() {
                this.storageKey = 'highschool_data';
                this.data = this.loadData();
            }

            loadData() {
                const savedData = localStorage.getItem(this.storageKey);
                if (savedData) {
                    return JSON.parse(savedData);
                }
                return this.getDefaultData();
            }

            getDefaultData() {
                return {
                    grades: {
                        year1: { sem1: [], sem2: [] },
                        year2: { sem1: [], sem2: [] },
                        year3: { sem1: [], sem2: [] }
                    },
                    yearRecords: {
                        year1: { memory: '', achievements: [] },
                        year2: { memory: '', achievements: [] },
                        year3: { memory: '', achievements: [] }
                    },
                    finalMessage: ''
                };
            }

            saveData() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            }

            addGrade(year, semester, subject, score) {
                const yearKey = `year${year}`;
                const semKey = `sem${semester}`;
                
                if (!this.data.grades[yearKey][semKey]) {
                    this.data.grades[yearKey][semKey] = [];
                }

                this.data.grades[yearKey][semKey].push({
                    subject,
                    score,
                    date: new Date().toISOString()
                });
                
                this.saveData();
            }

            getGrades(year, semester) {
                const yearKey = `year${year}`;
                const semKey = `sem${semester}`;
                return this.data.grades[yearKey][semKey] || [];
            }

            calculateAverage(year, semester) {
                const grades = this.getGrades(year, semester);
                if (grades.length === 0) return 0;
                
                const sum = grades.reduce((acc, grade) => acc + parseFloat(grade.score), 0);
                return (sum / grades.length).toFixed(2);
            }

            updateYearRecord(year, field, value) {
                const yearKey = `year${year}`;
                if (!this.data.yearRecords[yearKey]) {
                    this.data.yearRecords[yearKey] = {};
                }
                this.data.yearRecords[yearKey][field] = value;
                this.saveData();
            }

            getYearRecord(year) {
                return this.data.yearRecords[`year${year}`];
            }

            updateFinalMessage(message) {
                this.data.finalMessage = message;
                this.saveData();
            }

            getAllData() {
                return this.data;
            }
        }

        class DiaryManager {
            constructor() {
                this.storageKey = 'highschool_diary';
                this.diaries = this.loadDiaries();
            }

            loadDiaries() {
                const saved = localStorage.getItem(this.storageKey);
                return saved ? JSON.parse(saved) : [];
            }

            saveDiaries() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.diaries));
            }

            addDiary(title, content, mood = 'ğŸ˜Š', year = 1) {
                const diary = {
                    id: Date.now().toString(),
                    title,
                    content,
                    mood,
                    year,
                    date: new Date().toISOString(),
                    createdAt: new Date().toLocaleString('ko-KR')
                };

                this.diaries.unshift(diary);
                this.saveDiaries();
                return diary;
            }

            deleteDiary(id) {
                const index = this.diaries.findIndex(d => d.id === id);
                if (index !== -1) {
                    this.diaries.splice(index, 1);
                    this.saveDiaries();
                    return true;
                }
                return false;
            }

            getAllDiaries() {
                return this.diaries;
            }
        }

        // ==================== UI ì»´í¬ë„ŒíŠ¸ í´ë˜ìŠ¤ë“¤ ====================

        class Button {
            constructor(scene, x, y, text, callback, color = 0x1976d2, width = 300) {
                this.scene = scene;
                this.callback = callback;
                this.width = width;
                this.height = 50;
                this.x = x;
                this.y = y;

                this.shadow = scene.add.graphics();
                this.shadow.fillStyle(0x000000, 0.2);
                this.shadow.fillRoundedRect(x - width / 2, y - this.height / 2 + 4, width, this.height, 10);

                this.background = scene.add.graphics();
                this.background.fillStyle(color, 1);
                this.background.fillRoundedRect(x - width / 2, y - this.height / 2, width, this.height, 10);

                this.text = scene.add.text(x, y, text, {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: '#ffffff',
                    fontStyle: 'bold'
                });
                this.text.setOrigin(0.5);

                this.hitArea = scene.add.rectangle(x, y, width, this.height, 0x000000, 0);
                this.hitArea.setInteractive({ useHandCursor: true });

                this.hitArea.on('pointerover', () => this.onHover());
                this.hitArea.on('pointerout', () => this.onOut());
                this.hitArea.on('pointerdown', () => this.onClick());

                this.originalColor = color;
            }

            onHover() {
                this.background.clear();
                this.background.fillStyle(this.originalColor, 0.85);
                this.background.fillRoundedRect(
                    this.x - this.width / 2,
                    this.y - this.height / 2,
                    this.width,
                    this.height,
                    10
                );
                this.scene.tweens.add({
                    targets: [this.background, this.text, this.shadow],
                    scaleX: 1.05,
                    scaleY: 1.05,
                    duration: 100
                });
            }

            onOut() {
                this.background.clear();
                this.background.fillStyle(this.originalColor, 1);
                this.background.fillRoundedRect(
                    this.x - this.width / 2,
                    this.y - this.height / 2,
                    this.width,
                    this.height,
                    10
                );
                this.scene.tweens.add({
                    targets: [this.background, this.text, this.shadow],
                    scaleX: 1,
                    scaleY: 1,
                    duration: 100
                });
            }

            onClick() {
                this.scene.tweens.add({
                    targets: [this.background, this.text],
                    scaleX: 0.95,
                    scaleY: 0.95,
                    duration: 50,
                    yoyo: true,
                    onComplete: () => {
                        if (this.callback) {
                            this.callback();
                        }
                    }
                });
            }

            destroy() {
                this.background.destroy();
                this.shadow.destroy();
                this.text.destroy();
                this.hitArea.destroy();
            }
        }

        class InputField {
            constructor(scene, x, y, width, height, defaultValue = '', placeholder = '', type = 'text') {
                this.scene = scene;
                this.value = defaultValue;

                const isTextarea = type === 'textarea';
                this.element = document.createElement(isTextarea ? 'textarea' : 'input');
                
                if (!isTextarea) {
                    this.element.type = type;
                }

                this.element.className = 'phaser-input';
                Object.assign(this.element.style, {
                    width: `${width}px`,
                    height: `${height}px`,
                    padding: '12px',
                    fontSize: '15px',
                    resize: isTextarea ? 'vertical' : 'none',
                    backgroundColor: '#ffffff',
                    color: '#333333'
                });

                this.element.placeholder = placeholder;
                this.element.value = defaultValue;

                this.element.addEventListener('input', () => {
                    this.value = this.element.value;
                });

                this.domElement = scene.add.dom(x + width / 2, y + height / 2, this.element);

                scene.events.on('shutdown', () => {
                    this.destroy();
                });
            }

            getValue() {
                return this.element.value;
            }

            setValue(value) {
                this.element.value = value;
                this.value = value;
            }

            destroy() {
                if (this.element && this.element.parentNode) {
                    this.element.parentNode.removeChild(this.element);
                }
                if (this.domElement) {
                    this.domElement.destroy();
                }
            }
        }

        class Card {
            constructor(scene, x, y, width, height, icon, label, value) {
                const card = scene.add.graphics();
                card.fillStyle(0xffffff, 1);
                card.fillRoundedRect(x, y, width, height, 12);
                card.lineStyle(2, 0x64b5f6, 1);
                card.strokeRoundedRect(x, y, width, height, 12);

                scene.add.text(x + width / 2, y + 35, icon, {
                    fontSize: '32px'
                }).setOrigin(0.5);

                scene.add.text(x + width / 2, y + 75, label, {
                    fontFamily: 'Arial',
                    fontSize: '14px',
                    color: '#666666'
                }).setOrigin(0.5);

                scene.add.text(x + width / 2, y + 105, value, {
                    fontFamily: 'Arial',
                    fontSize: '24px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
            }
        }

        class NavBar {
            constructor(scene, onLogout) {
                const width = scene.cameras.main.width;

                const navbar = scene.add.graphics();
                navbar.fillStyle(0x1976d2, 1);
                navbar.fillRect(0, 0, width, 60);

                scene.add.text(30, 30, 'ğŸ“ ë‚˜ì˜ ê³ ë“±í•™êµ 3ë…„', {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#ffffff',
                    fontStyle: 'bold'
                }).setOrigin(0, 0.5);

                const homeBtn = scene.add.text(width - 250, 30, 'ğŸ  í™ˆ', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#ffffff',
                    backgroundColor: 'rgba(255, 255, 255, 0.2)',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0, 0.5);
                homeBtn.setInteractive({ useHandCursor: true });
                homeBtn.on('pointerdown', () => {
                    scene.scene.start('MainDashboard');
                });

                const logoutBtn = scene.add.text(width - 120, 30, 'ğŸšª ë¡œê·¸ì•„ì›ƒ', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#ffffff',
                    backgroundColor: 'rgba(255, 255, 255, 0.2)',
                    padding: { x: 15, y: 8 }
                }).setOrigin(0, 0.5);
                logoutBtn.setInteractive({ useHandCursor: true });
                logoutBtn.on('pointerdown', () => {
                    if (onLogout) {
                        onLogout();
                    }
                });
            }
        }

        // ==================== Scene í´ë˜ìŠ¤ë“¤ ====================

        class PreloadScene extends Phaser.Scene {
            constructor() {
                super({ key: 'PreloadScene' });
            }

            preload() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                const progressBox = this.add.graphics();
                progressBox.fillStyle(0x64b5f6, 0.3);
                progressBox.fillRoundedRect(width / 2 - 200, height / 2 - 30, 400, 60, 10);

                const progressBar = this.add.graphics();

                const loadingText = this.add.text(width / 2, height / 2 - 80, 'ë¡œë”© ì¤‘...', {
                    fontFamily: 'Arial',
                    fontSize: '28px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                });
                loadingText.setOrigin(0.5);

                const percentText = this.add.text(width / 2, height / 2, '0%', {
                    fontFamily: 'Arial',
                    fontSize: '22px',
                    color: '#1976d2'
                });
                percentText.setOrigin(0.5);

                this.load.on('progress', (value) => {
                    progressBar.clear();
                    progressBar.fillStyle(0x1976d2, 1);
                    progressBar.fillRoundedRect(width / 2 - 190, height / 2 - 20, 380 * value, 40, 8);
                    percentText.setText(parseInt(value * 100) + '%');
                });

                this.load.on('complete', () => {
                    progressBar.destroy();
                    progressBox.destroy();
                    loadingText.destroy();
                    percentText.destroy();
                });

                for (let i = 0; i < 10; i++) {
                    this.load.image(`dummy${i}`, 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');
                }
            }

            create() {
                this.registry.set('authManager', new AuthManager());
                this.registry.set('dataManager', new DataManager());
                this.registry.set('diaryManager', new DiaryManager());

                const authManager = this.registry.get('authManager');
                if (authManager.isLoggedIn()) {
                    this.scene.start('MainDashboard');
                } else {
                    this.scene.start('LoginScene');
                }
            }
        }

        class LoginScene extends Phaser.Scene {
            constructor() {
                super({ key: 'LoginScene' });
            }

            create() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.authManager = this.registry.get('authManager');

                const bg = this.add.graphics();
                bg.fillGradientStyle(0x42a5f5, 0x42a5f5, 0x1976d2, 0x1976d2, 1);
                bg.fillRect(0, 0, width, height);

                const cardWidth = 500;
                const cardHeight = 550;
                const cardX = width / 2 - cardWidth / 2;
                const cardY = height / 2 - cardHeight / 2;

                const card = this.add.graphics();
                card.fillStyle(0xffffff, 1);
                card.fillRoundedRect(cardX, cardY, cardWidth, cardHeight, 16);
                card.lineStyle(4, 0x64b5f6, 1);
                card.strokeRoundedRect(cardX, cardY, cardWidth, cardHeight, 16);

                this.add.text(width / 2, cardY + 80, 'ğŸ“', {
                    fontSize: '64px'
                }).setOrigin(0.5);

                this.add.text(width / 2, cardY + 160, 'ë‚˜ì˜ ê³ ë“±í•™êµ 3ë…„', {
                    fontFamily: 'Arial',
                    fontSize: '32px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                this.add.text(width / 2, cardY + 200, 'ì†Œì¤‘í•œ ì¶”ì–µì„ ê¸°ë¡í•˜ëŠ” ê³µê°„', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#666666'
                }).setOrigin(0.5);

                this.add.text(cardX + 50, cardY + 260, 'ì•„ì´ë””', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                });

                this.usernameInput = new InputField(
                    this,
                    cardX + 50,
                    cardY + 290,
                    cardWidth - 100,
                    45,
                    '',
                    'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                    'text'
                );

                this.add.text(cardX + 50, cardY + 360, 'ë¹„ë°€ë²ˆí˜¸', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                });

                this.passwordInput = new InputField(
                    this,
                    cardX + 50,
                    cardY + 390,
                    cardWidth - 100,
                    45,
                    '',
                    'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                    'password'
                );

                this.errorText = this.add.text(width / 2, cardY + 460, '', {
                    fontFamily: 'Arial',
                    fontSize: '14px',
                    color: '#d32f2f'
                }).setOrigin(0.5);

                new Button(
                    this,
                    width / 2,
                    cardY + 490,
                    'ë¡œê·¸ì¸',
                    () => this.handleLogin(),
                    0x1976d2,
                    cardWidth - 100
                );

                this.add.text(width / 2, height - 50, 'ê¸°ë³¸ ê³„ì • - ID: admin / PW: 1234', {
                    fontFamily: 'Arial',
                    fontSize: '14px',
                    color: '#ffffff',
                    alpha: 0.8
                }).setOrigin(0.5);

                this.input.keyboard.on('keydown-ENTER', () => {
                    this.handleLogin();
                });
            }

            handleLogin() {
                const username = this.usernameInput.getValue().trim();
                const password = this.passwordInput.getValue().trim();

                if (!username || !password) {
                    this.showError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (this.authManager.login(username, password)) {
                    this.showSuccess('ë¡œê·¸ì¸ ì„±ê³µ!');
                    this.time.delayedCall(500, () => {
                        this.scene.start('MainDashboard');
                    });
                } else {
                    this.showError('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    this.cameras.main.shake(200, 0.005);
                }
            }

            showError(message) {
                this.errorText.setText(message);
                this.tweens.add({
                    targets: this.errorText,
                    alpha: { from: 1, to: 0 },
                    duration: 3000,
                    ease: 'Power2'
                });
            }

            showSuccess(message) {
                this.errorText.setColor('#2e7d32');
                this.errorText.setText(message);
            }
        }

        class MainDashboard extends Phaser.Scene {
            constructor() {
                super({ key: 'MainDashboard' });
            }

            create() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.authManager = this.registry.get('authManager');
                this.dataManager = this.registry.get('dataManager');
                this.diaryManager = this.registry.get('diaryManager');

                const user = this.authManager.getCurrentUser();

                const bg = this.add.graphics();
                bg.fillStyle(0xe3f2fd, 1);
                bg.fillRect(0, 0, width, height);

                new NavBar(this, () => {
                    this.authManager.logout();
                    this.scene.start('LoginScene');
                });

                this.add.text(width / 2, 120, `í™˜ì˜í•©ë‹ˆë‹¤, ${user.name}ë‹˜! ğŸ‰`, {
                    fontFamily: 'Arial',
                    fontSize: '36px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                this.add.text(width / 2, 170, 'ì˜¤ëŠ˜ë„ ì†Œì¤‘í•œ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”', {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: '#666666'
                }).setOrigin(0.5);

                this.createStatCards();
                this.createMainMenu();
            }

            createStatCards() {
                const width = this.cameras.main.width;
                const cardWidth = 250;
                const cardHeight = 140;
                const startX = 150;
                const startY = 240;
                const gap = 280;

                const diaryCount = this.diaryManager.getAllDiaries().length;
                new Card(this, startX, startY, cardWidth, cardHeight, 'ğŸ“”', 'ì‘ì„±í•œ ì¼ê¸°', `${diaryCount}ê°œ`);

                let totalGrades = [];
                for (let year = 1; year <= 3; year++) {
                    for (let sem = 1; sem <= 2; sem++) {
                        const grades = this.dataManager.getGrades(year, sem);
                        totalGrades = totalGrades.concat(grades);
                    }
                }
                const avgGrade = totalGrades.length > 0
                    ? (totalGrades.reduce((sum, g) => sum + parseFloat(g.score), 0) / totalGrades.length).toFixed(2)
                    : '0.00';
                new Card(this, startX + gap, startY, cardWidth, cardHeight, 'ğŸ“Š', 'í‰ê·  ì„±ì ', avgGrade);

                const recordDays = totalGrades.length + diaryCount;
                new Card(this, startX + gap * 2, startY, cardWidth, cardHeight, 'ğŸ“…', 'ê¸°ë¡í•œ ë‚ ', `${recordDays}ì¼`);

                const today = new Date();
                const graduation = new Date(today.getFullYear(), 1, 28);
                if (graduation < today) {
                    graduation.setFullYear(graduation.getFullYear() + 1);
                }
                const daysLeft = Math.ceil((graduation - today) / (1000 * 60 * 60 * 24));
                new Card(this, startX + gap * 3, startY, cardWidth, cardHeight, 'â°', 'ì¡¸ì—…ê¹Œì§€', `D-${daysLeft}`);
            }

            createMainMenu() {
                const width = this.cameras.main.width;
                const buttonWidth = 350;
                const startY = 450;
                const gap = 100;

                new Button(
                    this,
                    width / 2 - 200,
                    startY,
                    'ğŸ“ ì¼ê¸° ì‘ì„±',
                    () => this.scene.start('DiaryScene'),
                    0x42a5f5,
                    buttonWidth
                );

                new Button(
                    this,
                    width / 2 + 200,
                    startY,
                    'ğŸ“Š ì„±ì  ê´€ë¦¬',
                    () => this.scene.start('GradeScene'),
                    0x66bb6a,
                    buttonWidth
                );

                new Button(
                    this,
                    width / 2 - 200,
                    startY + gap,
                    'ğŸ“š 1í•™ë…„ ê¸°ë¡',
                    () => this.scene.start('YearRecordScene', { year: 1 }),
                    0xffa726,
                    buttonWidth
                );

                new Button(
                    this,
                    width / 2 + 200,
                    startY + gap,
                    'ğŸŒŸ 2í•™ë…„ ê¸°ë¡',
                    () => this.scene.start('YearRecordScene', { year: 2 }),
                    0xec407a,
                    buttonWidth
                );

                new Button(
                    this,
                    width / 2 - 200,
                    startY + gap * 2,
                    'âœ¨ 3í•™ë…„ ê¸°ë¡',
                    () => this.scene.start('YearRecordScene', { year: 3 }),
                    0xab47bc,
                    buttonWidth
                );

                new Button(
                    this,
                    width / 2 + 200,
                    startY + gap * 2,
                    'ğŸ’Œ ìµœì¢… ë©”ì‹œì§€',
                    () => this.showFinalMessage(),
                    0xef5350,
                    buttonWidth
                );
            }

            showFinalMessage() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                const modalBg = this.add.graphics();
                modalBg.fillStyle(0x000000, 0.7);
                modalBg.fillRect(0, 0, width, height);
                modalBg.setInteractive(new Phaser.Geom.Rectangle(0, 0, width, height), Phaser.Geom.Rectangle.Contains);
                modalBg.setDepth(1000);

                const modal = this.add.graphics();
                modal.fillStyle(0xffffff, 1);
                modal.fillRoundedRect(200, 150, 800, 500, 16);
                modal.setDepth(1001);

                const titleText = this.add.text(width / 2, 220, 'ğŸ’Œ ë‚˜ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§', {
                    fontFamily: 'Arial',
                    fontSize: '32px',
                    color: '#1976d2',
                    fontStyle: 'bold'
                }).setOrigin(0.5).setDepth(1002);

                const finalMessage = this.dataManager.getAllData().finalMessage || 'ì•„ì§ ì‘ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';

                const messageText = this.add.text(250, 280, finalMessage, {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: '#333333',
                    wordWrap: { width: 700 },
                    lineSpacing: 10
                }).setDepth(1002);

                const closeBtn = new Button(
                    this,
                    width / 2,
                    580,
                    'ë‹«ê¸°',
                    () => {
                        modalBg.destroy();
                        modal.destroy();
                        messageText.destroy();
                        titleText.destroy();
                        closeBtn.destroy();
                    },
                    0x757575,
                    200
                );
                closeBtn.background.setDepth(1002);
                closeBtn.text.setDepth(1003);
                closeBtn.hitArea.setDepth(1003);
            }
        }

        class DiaryScene extends Phaser.Scene {
            constructor() {
                super({ key: 'DiaryScene' });
            }

            create() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.diaryManager = this.registry.get('diaryManager');

                const bg = this.add.graphics();
                bg.fillStyle(0xfff8e1, 1);
                bg.fillRect(0, 0, width, height);

                new NavBar(this, () => this.scene.start('MainDashboard'));

                this.add.text(width / 2, 100, 'ğŸ“ ì¼ê¸° ì‘ì„±', {
                    fontFamily: 'Arial',
                    fontSize: '36px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                this.createDiaryForm();
                this.createDiaryList();
            }

            createDiaryForm() {
                const formX = 50;
                const formY = 160;
                const formWidth = 550;

                const form = this.add.graphics();
                form.fillStyle(0xffffff, 1);
                form.fillRoundedRect(formX, formY, formWidth, 580, 12);
                form.lineStyle(3, 0xffa726, 1);
                form.strokeRoundedRect(formX, formY, formWidth, 580, 12);

                this.add.text(formX + 30, formY + 30, 'ì œëª©', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                });

                this.titleInput = new InputField(
                    this,
                    formX + 30,
                    formY + 60,
                    formWidth - 60,
                    45,
                    '',
                    'ì¼ê¸° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”',
                    'text'
                );

                this.add.text(formX + 30, formY + 130, 'í•™ë…„', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                });

                this.yearSelect = this.createYearSelector(formX + 30, formY + 160);

                this.add.text(formX + 30, formY + 230, 'ì˜¤ëŠ˜ì˜ ê¸°ë¶„', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                });

                this.moodSelect = this.createMoodSelector(formX + 30, formY + 260);

                this.add.text(formX + 30, formY + 330, 'ë‚´ìš©', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                });

                this.contentInput = new InputField(
                    this,
                    formX + 30,
                    formY + 360,
                    formWidth - 60,
                    150,
                    '',
                    'ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”...',
                    'textarea'
                );

                new Button(
                    this,
                    formX + formWidth / 2,
                    formY + 540,
                    'ğŸ’¾ ì €ì¥í•˜ê¸°',
                    () => this.saveDiary(),
                    0xffa726,
                    formWidth - 60
                );
            }

            createYearSelector(x, y) {
                const years = [1, 2, 3];
                let selectedYear = 1;

                const buttons = years.map((year, index) => {
                    const btn = this.add.text(x + index * 80, y, `${year}í•™ë…„`, {
                        fontFamily: 'Arial',
                        fontSize: '16px',
                        color: '#ffffff',
                        backgroundColor: year === 1 ? '#ffa726' : '#cccccc',
                        padding: { x: 15, y: 8 }
                    });
                    btn.setInteractive({ useHandCursor: true });
                    btn.on('pointerdown', () => {
                        selectedYear = year;
                        buttons.forEach((b, i) => {
                            b.setBackgroundColor(years[i] === year ? '#ffa726' : '#cccccc');
                        });
                    });
                    return btn;
                });

                return { getValue: () => selectedYear };
            }

            createMoodSelector(x, y) {
                const moods = ['ğŸ˜Š', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ˜´', 'ğŸ¤”', 'ğŸ‰'];
                let selectedMood = 'ğŸ˜Š';

                const buttons = moods.map((mood, index) => {
                    const btn = this.add.text(x + index * 70, y, mood, {
                        fontSize: '32px',
                        backgroundColor: index === 0 ? '#fff3e0' : 'transparent',
                        padding: { x: 10, y: 5 }
                    });
                    btn.setInteractive({ useHandCursor: true });
                    btn.on('pointerdown', () => {
                        selectedMood = mood;
                        buttons.forEach((b, i) => {
                            b.setBackgroundColor(moods[i] === mood ? '#fff3e0' : 'transparent');
                        });
                    });
                    return btn;
                });

                return { getValue: () => selectedMood };
            }

            createDiaryList() {
                const listX = 650;
                const listY = 160;
                const listWidth = 500;

                const listBg = this.add.graphics();
                listBg.fillStyle(0xffffff, 1);
                listBg.fillRoundedRect(listX, listY, listWidth, 580, 12);
                listBg.lineStyle(3, 0xffa726, 1);
                listBg.strokeRoundedRect(listX, listY, listWidth, 580, 12);

                this.add.text(listX + 20, listY + 20, 'ğŸ“š ìµœê·¼ ì¼ê¸°', {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#f57c00',
                    fontStyle: 'bold'
                });

                const diaries = this.diaryManager.getAllDiaries().slice(0, 8);

                if (diaries.length === 0) {
                    this.add.text(listX + listWidth / 2, listY + 300, 'ì•„ì§ ì‘ì„±í•œ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤', {
                        fontFamily: 'Arial',
                        fontSize: '16px',
                        color: '#999999'
                    }).setOrigin(0.5);
                } else {
                    diaries.forEach((diary, index) => {
                        const itemY = listY + 70 + index * 60;
                        
                        const item = this.add.graphics();
                        item.fillStyle(0xfff8e1, 1);
                        item.fillRoundedRect(listX + 20, itemY, listWidth - 40, 50, 8);

                        this.add.text(listX + 40, itemY + 10, `${diary.mood} ${diary.title}`, {
                            fontFamily: 'Arial',
                            fontSize: '14px',
                            color: '#333333',
                            fontStyle: 'bold'
                        });

                        this.add.text(listX + 40, itemY + 30, diary.createdAt, {
                            fontFamily: 'Arial',
                            fontSize: '12px',
                            color: '#999999'
                        });

                        const deleteBtn = this.add.text(listX + listWidth - 70, itemY + 15, 'ğŸ—‘ï¸', {
                            fontSize: '20px'
                        });
                        deleteBtn.setInteractive({ useHandCursor: true });
                        deleteBtn.on('pointerdown', () => {
                            this.diaryManager.deleteDiary(diary.id);
                            this.scene.restart();
                        });
                    });
                }
            }

            saveDiary() {
                const title = this.titleInput.getValue().trim();
                const content = this.contentInput.getValue().trim();
                const year = this.yearSelect.getValue();
                const mood = this.moodSelect.getValue();

                if (!title || !content) {
                    this.showMessage('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', '#d32f2f');
                    return;
                }

                this.diaryManager.addDiary(title, content, mood, year);
                this.showMessage('ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨', '#2e7d32');

                this.time.delayedCall(1000, () => {
                    this.scene.restart();
                });
            }

            showMessage(text, color) {
                const msg = this.add.text(this.cameras.main.width / 2, 100, text, {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#ffffff',
                    backgroundColor: color,
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setDepth(1000);

                this.tweens.add({
                    targets: msg,
                    alpha: 0,
                    y: 50,
                    duration: 2000,
                    onComplete: () => msg.destroy()
                });
            }
        }

        class GradeScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GradeScene' });
            }

            create() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.dataManager = this.registry.get('dataManager');

                const bg = this.add.graphics();
                bg.fillStyle(0xe8f5e9, 1);
                bg.fillRect(0, 0, width, height);

                new NavBar(this, () => this.scene.start('MainDashboard'));

                this.add.text(width / 2, 100, 'ğŸ“Š ì„±ì  ê´€ë¦¬', {
                    fontFamily: 'Arial',
                    fontSize: '36px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                this.createGradeForm();
                this.createGradeStats();
            }

            createGradeForm() {
                const formX = 50;
                const formY = 160;
                const formWidth = 550;

                const form = this.add.graphics();
                form.fillStyle(0xffffff, 1);
                form.fillRoundedRect(formX, formY, formWidth, 580, 12);
                form.lineStyle(3, 0x66bb6a, 1);
                form.strokeRoundedRect(formX, formY, formWidth, 580, 12);

                this.add.text(formX + 30, formY + 30, 'í•™ë…„', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                this.yearSelect = this.createSelector(
                    formX + 30,
                    formY + 60,
                    ['1í•™ë…„', '2í•™ë…„', '3í•™ë…„'],
                    [1, 2, 3]
                );

                this.add.text(formX + 300, formY + 30, 'í•™ê¸°', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                this.semesterSelect = this.createSelector(
                    formX + 300,
                    formY + 60,
                    ['1í•™ê¸°', '2í•™ê¸°'],
                    [1, 2]
                );

                this.add.text(formX + 30, formY + 150, 'ê³¼ëª©ëª…', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                this.subjectInput = new InputField(
                    this,
                    formX + 30,
                    formY + 180,
                    formWidth - 60,
                    45,
                    '',
                    'ì˜ˆ: êµ­ì–´, ìˆ˜í•™, ì˜ì–´',
                    'text'
                );

                this.add.text(formX + 30, formY + 250, 'ì ìˆ˜ (0-100)', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                this.scoreInput = new InputField(
                    this,
                    formX + 30,
                    formY + 280,
                    formWidth - 60,
                    45,
                    '',
                    'ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                    'number'
                );

                new Button(
                    this,
                    formX + formWidth / 2,
                    formY + 380,
                    'ğŸ’¾ ì„±ì  ì €ì¥',
                    () => this.saveGrade(),
                    0x66bb6a,
                    formWidth - 60
                );

                this.add.text(formX + 30, formY + 450, 'ìµœê·¼ ì…ë ¥í•œ ì„±ì ', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                this.recentGradesList = this.add.text(formX + 30, formY + 480, '', {
                    fontFamily: 'Arial',
                    fontSize: '14px',
                    color: '#333333',
                    lineSpacing: 5
                });

                this.updateRecentGrades();
            }

            createSelector(x, y, labels, values) {
                let selectedValue = values[0];

                const buttons = labels.map((label, index) => {
                    const btn = this.add.text(x + index * 110, y, label, {
                        fontFamily: 'Arial',
                        fontSize: '14px',
                        color: '#ffffff',
                        backgroundColor: index === 0 ? '#66bb6a' : '#cccccc',
                        padding: { x: 12, y: 8 }
                    });
                    btn.setInteractive({ useHandCursor: true });
                    btn.on('pointerdown', () => {
                        selectedValue = values[index];
                        buttons.forEach((b, i) => {
                            b.setBackgroundColor(i === index ? '#66bb6a' : '#cccccc');
                        });
                    });
                    return btn;
                });

                return { getValue: () => selectedValue };
            }

            createGradeStats() {
                const statsX = 650;
                const statsY = 160;
                const statsWidth = 500;

                const statsBg = this.add.graphics();
                statsBg.fillStyle(0xffffff, 1);
                statsBg.fillRoundedRect(statsX, statsY, statsWidth, 580, 12);
                statsBg.lineStyle(3, 0x66bb6a, 1);
                statsBg.strokeRoundedRect(statsX, statsY, statsWidth, 580, 12);

                this.add.text(statsX + 20, statsY + 20, 'ğŸ“ˆ ì„±ì  í†µê³„', {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                const startY = statsY + 80;
                const rowHeight = 80;

                for (let year = 1; year <= 3; year++) {
                    const y = startY + (year - 1) * rowHeight;
                    
                    const card = this.add.graphics();
                    card.fillStyle(0xe8f5e9, 1);
                    card.fillRoundedRect(statsX + 20, y, statsWidth - 40, 70, 8);

                    this.add.text(statsX + 40, y + 10, `${year}í•™ë…„`, {
                        fontFamily: 'Arial',
                        fontSize: '18px',
                        color: '#2e7d32',
                        fontStyle: 'bold'
                    });

                    const sem1Avg = this.dataManager.calculateAverage(year, 1);
                    const sem2Avg = this.dataManager.calculateAverage(year, 2);
                    const yearAvg = ((parseFloat(sem1Avg) + parseFloat(sem2Avg)) / 2).toFixed(2);

                    this.add.text(statsX + 40, y + 40, `1í•™ê¸°: ${sem1Avg}ì  | 2í•™ê¸°: ${sem2Avg}ì  | í‰ê· : ${yearAvg}ì `, {
                        fontFamily: 'Arial',
                        fontSize: '14px',
                        color: '#666666'
                    });
                }

                const totalCard = this.add.graphics();
                totalCard.fillStyle(0xc8e6c9, 1);
                totalCard.fillRoundedRect(statsX + 20, startY + 260, statsWidth - 40, 80, 8);

                this.add.text(statsX + 40, startY + 280, 'ğŸ¯ ì „ì²´ í‰ê· ', {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#1b5e20',
                    fontStyle: 'bold'
                });

                let allGrades = [];
                for (let year = 1; year <= 3; year++) {
                    for (let sem = 1; sem <= 2; sem++) {
                        const grades = this.dataManager.getGrades(year, sem);
                        allGrades = allGrades.concat(grades);
                    }
                }

                const totalAvg = allGrades.length > 0
                    ? (allGrades.reduce((sum, g) => sum + parseFloat(g.score), 0) / allGrades.length).toFixed(2)
                    : '0.00';

                this.add.text(statsX + 40, startY + 315, `${totalAvg}ì  (${allGrades.length}ê°œ ê³¼ëª©)`, {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: '#1b5e20'
                });

                this.createSimpleChart(statsX + 40, startY + 380, statsWidth - 80, 140);
            }

            createSimpleChart(x, y, width, height) {
                this.add.text(x, y - 30, 'ğŸ“Š í•™ê¸°ë³„ í‰ê·  ì¶”ì´', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#2e7d32',
                    fontStyle: 'bold'
                });

                const chart = this.add.graphics();
                const barWidth = width / 6 - 10;
                const maxHeight = height - 30;

                let index = 0;
                for (let year = 1; year <= 3; year++) {
                    for (let sem = 1; sem <= 2; sem++) {
                        const avg = parseFloat(this.dataManager.calculateAverage(year, sem));
                        const barHeight = (avg / 100) * maxHeight;
                        
                        const barX = x + index * (barWidth + 10);
                        const barY = y + height - barHeight;

                        chart.fillStyle(0x66bb6a, 1);
                        chart.fillRoundedRect(barX, barY, barWidth, barHeight, 4);

                        this.add.text(barX + barWidth / 2, barY - 15, avg.toFixed(1), {
                            fontFamily: 'Arial',
                            fontSize: '12px',
                            color: '#2e7d32',
                            fontStyle: 'bold'
                        }).setOrigin(0.5);

                        this.add.text(barX + barWidth / 2, y + height + 5, `${year}-${sem}`, {
                            fontFamily: 'Arial',
                            fontSize: '11px',
                            color: '#666666'
                        }).setOrigin(0.5, 0);

                        index++;
                    }
                }
            }

            saveGrade() {
                const year = this.yearSelect.getValue();
                const semester = this.semesterSelect.getValue();
                const subject = this.subjectInput.getValue().trim();
                const score = this.scoreInput.getValue().trim();

                if (!subject || !score) {
                    this.showMessage('ê³¼ëª©ëª…ê³¼ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', '#d32f2f');
                    return;
                }

                const scoreNum = parseFloat(score);
                if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 100) {
                    this.showMessage('ì ìˆ˜ëŠ” 0-100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!', '#d32f2f');
                    return;
                }

                this.dataManager.addGrade(year, semester, subject, scoreNum);
                this.showMessage('ì„±ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨', '#2e7d32');

                this.subjectInput.setValue('');
                this.scoreInput.setValue('');
                this.updateRecentGrades();

                this.time.delayedCall(500, () => {
                    this.scene.restart();
                });
            }

            updateRecentGrades() {
                const year = this.yearSelect.getValue();
                const semester = this.semesterSelect.getValue();
                const grades = this.dataManager.getGrades(year, semester).slice(-3);

                if (grades.length === 0) {
                    this.recentGradesList.setText('ì•„ì§ ì…ë ¥í•œ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    const text = grades.reverse().map(g => `â€¢ ${g.subject}: ${g.score}ì `).join('\n');
                    this.recentGradesList.setText(text);
                }
            }

            showMessage(text, color) {
                const msg = this.add.text(this.cameras.main.width / 2, 100, text, {
                    fontFamily: 'Arial',
                    fontSize: '20px',
                    color: '#ffffff',
                    backgroundColor: color,
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setDepth(1000);

                this.tweens.add({
                    targets: msg,
                    alpha: 0,
                    y: 50,
                    duration: 2000,
                    onComplete: () => msg.destroy()
                });
            }
        }

        class YearRecordScene extends Phaser.Scene {
            constructor() {
                super({ key: 'YearRecordScene' });
            }

            init(data) {
                this.year = data.year || 1;
            }

            create() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.dataManager = this.registry.get('dataManager');
                const yearData = this.dataManager.getYearRecord(this.year);

                const colors = {
                    1: { bg: 0xfce4ec, primary: 0xe91e63, text: '#c2185b' },
                    2: { bg: 0xf3e5f5, primary: 0x9c27b0, text: '#7b1fa2' },
                    3: { bg: 0xede7f6, primary: 0x673ab7, text: '#512da8' }
                };
                const color = colors[this.year];

                const bg = this.add.graphics();
                bg.fillStyle(color.bg, 1);
                bg.fillRect(0, 0, width, height);

                new NavBar(this, () => this.scene.start('MainDashboard'));

                const emojis = ['ğŸ“š', 'ğŸŒŸ', 'âœ¨'];
                this.add.text(width / 2, 100, `${emojis[this.year - 1]} ${this.year}í•™ë…„ ê¸°ë¡`, {
                    fontFamily: 'Arial',
                    fontSize: '36px',
                    color: color.text,
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                const cardWidth = 1100;
                const cardHeight = 600;
                const cardX = (width - cardWidth) / 2;
                const cardY = 160;

                const card = this.add.graphics();
                card.fillStyle(0xffffff, 1);
                card.fillRoundedRect(cardX, cardY, cardWidth, cardHeight, 12);
                card.lineStyle(3, color.primary, 1);
                card.strokeRoundedRect(cardX, cardY, cardWidth, cardHeight, 12);

                this.add.text(cardX + 40, cardY + 30, 'ğŸ’­ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„', {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: color.text,
                    fontStyle: 'bold'
                });

                this.memoryInput = new InputField(
                    this,
                    cardX + 40,
                    cardY + 65,
                    cardWidth - 80,
                    120,
                    yearData.memory || '',
                    'íŠ¹ë³„í–ˆë˜ ìˆœê°„ì„ ê¸°ë¡í•´ë³´ì„¸ìš”...',
                    'textarea'
                );

                this.add.text(cardX + 40, cardY + 210, 'ğŸ† ì´ë£¬ ì„±ì·¨ë“¤', {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: color.text,
                    fontStyle: 'bold'
                });

                this.achievementsInput = new InputField(
                    this,
                    cardX + 40,
                    cardY + 245,
                    cardWidth - 80,
                    120,
                    (yearData.achievements || []).join('\n'),
                    'ì˜ˆ: ìˆ˜í•™ ê²½ì‹œëŒ€íšŒ ê¸ˆìƒ, ë°˜ì¥ ë‹¹ì„ , ë™ì•„ë¦¬ ë¶€ì¥',
                    'textarea'
                );

                this.createGradeSummary(cardX + 40, cardY + 390, cardWidth - 80, color);

                new Button(
                    this,
                    width / 2,
                    cardY + cardHeight + 40,
                    'ğŸ’¾ ì €ì¥í•˜ê¸°',
                    () => this.saveYearRecord(),
                    color.primary,
                    300
                );
            }

            createGradeSummary(x, y, width, color) {
                this.add.text(x, y, 'ğŸ“Š ì´ í•™ë…„ ì„±ì  ìš”ì•½', {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: color.text,
                    fontStyle: 'bold'
                });

                const summaryBg = this.add.graphics();
                summaryBg.fillStyle(color.bg, 1);
                summaryBg.fillRoundedRect(x, y + 35, width, 120, 8);

                const sem1Avg = this.dataManager.calculateAverage(this.year, 1);
                const sem2Avg = this.dataManager.calculateAverage(this.year, 2);
                const yearAvg = ((parseFloat(sem1Avg) + parseFloat(sem2Avg)) / 2).toFixed(2);

                const sem1Grades = this.dataManager.getGrades(this.year, 1);
                const sem2Grades = this.dataManager.getGrades(this.year, 2);

                this.add.text(x + 30, y + 60, `1í•™ê¸° í‰ê· : ${sem1Avg}ì  (${sem1Grades.length}ê³¼ëª©)`, {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#333333'
                });

                this.add.text(x + 30, y + 90, `2í•™ê¸° í‰ê· : ${sem2Avg}ì  (${sem2Grades.length}ê³¼ëª©)`, {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#333333'
                });

                this.add.text(x + 30, y + 120, `ì—°ê°„ í‰ê· : ${yearAvg}ì `, {
                    fontFamily: 'Arial',
                    fontSize: '18px',
                    color: color.text,
                    fontStyle: 'bold'
                });

                const gradeBtn = this.add.text(x + width - 150, y + 85, 'âœ ì„±ì  ê´€ë¦¬', {
                    fontFamily: 'Arial',
                    fontSize: '14px',
                    color: '#ffffff',
                    backgroundColor: color.primary,
                    padding: { x: 15, y: 8 }
                });
                gradeBtn.setInteractive({ useHandCursor: true });
                gradeBtn.on('pointerdown', () => {
                    this.scene.start('GradeScene');
                });
            }

            saveYearRecord() {
                const memory = this.memoryInput.getValue().trim();
                const achievements = this.achievementsInput.getValue().trim().split('\n').filter(a => a);

                this.dataManager.updateYearRecord(this.year, 'memory', memory);
                this.dataManager.updateYearRecord(this.year, 'achievements', achievements);

                const msg = this.add.text(this.cameras.main.width / 2, 100, 'âœ¨ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', {
                    fontFamily: 'Arial',
                    fontSize: '24px',
                    color: '#ffffff',
                    backgroundColor: '#2e7d32',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setDepth(1000);

                this.tweens.add({
                    targets: msg,
                    alpha: 0,
                    y: 50,
                    duration: 2000,
                    onComplete: () => msg.destroy()
                });
            }
        }

        // ==================== Phaser ê²Œì„ ì„¤ì • ====================

        const config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 800,
            parent: 'game-container',
            backgroundColor: '#e3f2fd',
            dom: {
                createContainer: true
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            scene: [
                PreloadScene,
                LoginScene,
                MainDashboard,
                DiaryScene,
                GradeScene,
                YearRecordScene
            ]
        };

        window.addEventListener('load', () => {
            new Phaser.Game(config);
        });
    </script>
</body>
</html>
